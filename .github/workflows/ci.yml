name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          bundler-cache: true

      - name: Run tests with coverage
        run: bundle exec rspec --format documentation

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          bundler-cache: true

      - name: Run RuboCop
        run: bundle exec rubocop --format github

  security:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          bundler-cache: true

      - name: Run Bundle Audit
        run: bundle exec bundle-audit check --update

  code-analysis:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          bundler-cache: true

      - name: Run Reek
        run: bundle exec reek --format github lib/
        continue-on-error: true

  integration:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    environment: integration

    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          bundler-cache: true

      - name: Test data collection
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
         ./bin/ic_metrics collect ${{ vars.TEST_USERNAME }} --since=2025-10-01 --until=2025-10-31

      - name: Test analysis
        run: |
          ./bin/ic_metrics analyze ${{ vars.TEST_USERNAME }}

      - name: Test CSV export
        run: |
          ./bin/ic_metrics export ${{ vars.TEST_USERNAME }}
          ./bin/ic_metrics export-advanced enhanced ${{ vars.TEST_USERNAME }}

      - name: Test full analysis
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          DUST_API_KEY: ${{ secrets.DUST_API_KEY }}
          DUST_WORKSPACE_ID: ${{ secrets.DUST_WORKSPACE_ID }}
          DUST_AGENT_ID: ${{ vars.DUST_AGENT_ID }}
        run: |
          ./bin/ic_metrics_full_analysis ${{ vars.TEST_USERNAME }} --since=2025-10-01 --until=2025-10-31

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: integration-test-data
          path: data/
          retention-days: 7
